<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Resume Tailoring Assistant - Enhanced with Manual Entry</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        /* Debug Panel Styles */
        .debug-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 400px;
            max-height: 300px;
            background: rgba(0, 0, 0, 0.9);
            color: #00ff00;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-y: auto;
            z-index: 9999;
            display: none;
        }
        
        .debug-panel.active {
            display: block;
        }
        
        .debug-panel h3 {
            color: #00ff00;
            margin-bottom: 10px;
            border-bottom: 1px solid #00ff00;
            padding-bottom: 5px;
        }
        
        .debug-log {
            margin-bottom: 5px;
            padding: 3px;
            border-left: 3px solid #00ff00;
            padding-left: 10px;
        }
        
        .debug-log.error {
            border-left-color: #ff0000;
            color: #ff0000;
        }
        
        .debug-log.warning {
            border-left-color: #ffff00;
            color: #ffff00;
        }
        
        .debug-log.info {
            border-left-color: #00ffff;
            color: #00ffff;
        }
        
        .debug-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 10000;
            font-size: 14px;
        }
        
        .debug-toggle:hover {
            background: #555;
        }
        
        /* Data Inspector */
        .data-inspector {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 350px;
            max-height: 400px;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 15px;
            overflow-y: auto;
            display: none;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }
        
        .data-inspector.active {
            display: block;
        }
        
        .data-inspector h3 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .data-section {
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .data-section h4 {
            color: #333;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .data-count {
            font-weight: bold;
            color: #667eea;
        }
        
        .project-list {
            font-size: 12px;
            margin-top: 5px;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .project-item {
            padding: 2px 0;
            border-bottom: 1px solid #eee;
        }
        
        /* Page Navigation */
        .page-nav {
            max-width: 1200px;
            margin: 0 auto 20px;
            display: flex;
            gap: 10px;
        }
        
        .nav-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }
        
        .nav-btn.active {
            background: white;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        .nav-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.95);
        }
        
        /* Page Containers */
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.1em;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
        }
        
        .section h2 {
            color: #444;
            margin-bottom: 20px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
            font-family: inherit;
        }
        
        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        textarea {
            resize: vertical;
            min-height: 150px;
        }
        
        .file-upload {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
            margin-bottom: 15px;
        }
        
        .file-upload input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-upload-label {
            display: block;
            padding: 12px;
            background: #f0f0f0;
            border: 2px dashed #ccc;
            border-radius: 8px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .file-upload:hover .file-upload-label {
            background: #e8e8e8;
            border-color: #999;
        }
        
        .file-upload.has-file .file-upload-label {
            background: #e8f5e9;
            border-color: #4caf50;
            color: #2e7d32;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-save {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            font-size: 0.95em;
        }
        
        .btn-save:hover {
            background: #218838;
        }
        
        .btn-debug {
            background: #dc3545;
            color: white;
            padding: 10px 20px;
            font-size: 0.95em;
            margin-left: 10px;
        }
        
        .btn-debug:hover {
            background: #c82333;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin: 30px 0;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: #666;
            font-size: 1.1em;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .help-text {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        
        .saved-indicator {
            display: inline-block;
            padding: 4px 12px;
            background: #d4edda;
            color: #155724;
            border-radius: 4px;
            font-size: 0.85em;
            margin-left: 10px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .saved-indicator.show {
            opacity: 1;
        }
        
        /* Manual Entry Styles */
        .entry-group {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }
        
        .entry-group h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .dynamic-entry {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            position: relative;
        }
        
        .remove-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
        }
        
        .remove-btn:hover {
            background: #c82333;
        }
        
        .add-btn {
            background: #17a2b8;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.95em;
            margin-top: 10px;
        }
        
        .add-btn:hover {
            background: #138496;
        }
        
        .skill-category {
            margin-bottom: 15px;
        }
        
        .bullet-entry {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
            align-items: center;
        }
        
        .bullet-input {
            flex: 1;
        }
        
        .remove-bullet {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
        }
        
        .remove-bullet:hover {
            background: #c82333;
        }
        
        .date-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        /* Progress Indicator */
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            text-align: center;
            margin-top: 5px;
            color: #666;
            font-size: 0.9em;
        }
        
        /* Important Notice */
        .important-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #856404;
        }
        
        .important-notice h4 {
            margin-bottom: 5px;
            color: #856404;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <button class="debug-toggle" onclick="toggleDebug()">🐛 Toggle Debug</button>
    
    <div class="debug-panel" id="debugPanel">
        <h3>Debug Console</h3>
        <div id="debugLogs"></div>
    </div>
    
    <div class="data-inspector" id="dataInspector">
        <h3>📊 Data Inspector</h3>
        <div class="data-section">
            <h4>Resume Content Status</h4>
            <div>Length: <span class="data-count" id="resumeLength">0</span> characters</div>
            <div>Projects Found: <span class="data-count" id="projectCount">0</span></div>
            <div class="project-list" id="projectList"></div>
        </div>
        <div class="data-section">
            <h4>Job Description Status</h4>
            <div>Length: <span class="data-count" id="jdLength">0</span> characters</div>
        </div>
        <div class="data-section">
            <h4>Manual Entry Status</h4>
            <div>Experiences: <span class="data-count" id="manualExpCount">0</span></div>
            <div>Projects: <span class="data-count" id="manualProjCount">0</span></div>
            <div>Skills: <span class="data-count" id="manualSkillCount">0</span></div>
        </div>
        <div class="data-section">
            <h4>Last Action</h4>
            <div id="lastAction">None</div>
        </div>
    </div>
    
    <div class="page-nav">
        <button class="nav-btn active" onclick="showPage('ai-page')">
            🤖 AI-Powered Resume
        </button>
        <button class="nav-btn" onclick="showPage('manual-page')">
            ✍️ Manual Entry
        </button>
        <button class="nav-btn" onclick="showPage('edit-page')">
            ✏️ Edit & Finalize
        </button>
    </div>
    
    <div id="ai-page" class="page active">
        <div class="container">
            <div class="header">
                <h1>🎯 AI Resume Tailoring Assistant</h1>
                <p class="subtitle">Transform your resume for any job in seconds</p>
            </div>
            
            <div id="alert-ai" class="alert"></div>
            
            <div class="section">
                <h2>
                    <span>👤</span>
                    Your Information
                    <span class="saved-indicator" id="savedIndicator">✓ Saved</span>
                </h2>
                <div class="info-grid">
                    <input type="text" id="userName" placeholder="Full Name" onblur="saveUserInfo()">
                    <input type="text" id="userLocation" placeholder="City, State" onblur="saveUserInfo()">
                    <input type="tel" id="userPhone" placeholder="Phone Number" onblur="saveUserInfo()">
                    <input type="email" id="userEmail" placeholder="Email Address" onblur="saveUserInfo()">
                    <input type="text" id="userLinkedin" placeholder="LinkedIn URL" onblur="saveUserInfo()">
                </div>
                <button class="btn btn-save" onclick="saveUserInfo(true)">💾 Save Information</button>
                <button class="btn btn-debug" onclick="analyzeResumeContent()">🔍 Analyze Resume Content</button>
            </div>
            
            <div class="section">
                <h2><span>📄</span> Your Master Resume</h2>
                <div class="file-upload" id="fileUploadDiv">
                    <input type="file" id="resumeFile" accept=".docx,.txt" onchange="handleFileUpload(event)">
                    <label class="file-upload-label">
                        <span id="fileLabel">📁 Click to upload resume (.docx or .txt)</span>
                    </label>
                </div>
                <textarea id="resumeContent" placeholder="Or paste your complete resume here..." onchange="updateDataInspector()"></textarea>
                <p class="help-text">Include all your education, experience, projects, and skills</p>
            </div>
            
            <div class="section">
                <h2><span>💼</span> Target Job Description</h2>
                <textarea id="jobDescription" placeholder="Paste the complete job description here..." onchange="updateDataInspector()"></textarea>
                <p class="help-text">Include all requirements, responsibilities, and qualifications</p>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="tailorResume()">
                    <span>🚀</span> Tailor My Resume
                </button>
                <button class="btn btn-secondary" onclick="clearForm()">
                    <span>🗑️</span> Clear Form
                </button>
            </div>
            
            <div class="loading" id="loading-ai">
                <div class="spinner"></div>
                <p class="loading-text">AI is tailoring your resume... This may take 30-60 seconds.</p>
            </div>
        </div>
    </div>
    
    <div id="manual-page" class="page">
        <div class="container">
            <div class="header">
                <h1>✍️ Manual Resume Entry</h1>
                <p class="subtitle">Enter your master resume details for perfect workflow compatibility</p>
            </div>
            
            <div id="alert-manual" class="alert"></div>
            
            <div class="important-notice">
                <h4>⚠️ Important: This page is completely independent!</h4>
                <p>All information entered here is stored separately and will ONLY use what you enter on this page for resume generation.</p>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">0% Complete</div>
            
            <div class="entry-group">
                <h3>👤 Your Information</h3>
                <div class="info-grid">
                    <input type="text" id="manualName" placeholder="Full Name" onchange="saveManualData()">
                    <input type="text" id="manualLocation" placeholder="City, State" onchange="saveManualData()">
                    <input type="tel" id="manualPhone" placeholder="Phone Number" onchange="saveManualData()">
                    <input type="email" id="manualEmail" placeholder="Email Address" onchange="saveManualData()">
                    <input type="text" id="manualLinkedin" placeholder="LinkedIn URL" onchange="saveManualData()">
                </div>
            </div>
            
            <div class="entry-group">
                <h3>🎓 Education</h3>
                <div class="info-grid">
                    <input type="text" id="currentUniversity" placeholder="Current University" onchange="saveManualData()">
                    <input type="text" id="currentDegree" placeholder="Current Degree (e.g., Master of Science in Engineering)" onchange="saveManualData()">
                    <input type="text" id="currentGraduation" placeholder="Graduation Date (e.g., December 2025)" onchange="saveManualData()">
                    <input type="text" id="currentCoursework" placeholder="Relevant Coursework (comma-separated)" onchange="saveManualData()">
                </div>
                <h4 style="margin-top: 20px; margin-bottom: 10px;">Previous Education (Optional)</h4>
                <div class="info-grid">
                    <input type="text" id="previousUniversity" placeholder="Previous University" onchange="saveManualData()">
                    <input type="text" id="previousDegree" placeholder="Previous Degree" onchange="saveManualData()">
                    <input type="text" id="previousGraduation" placeholder="Previous Graduation Date" onchange="saveManualData()">
                </div>
            </div>
            
            <div class="entry-group">
                <h3>💻 Technical Skills</h3>
                <p class="help-text" style="margin-bottom: 15px;">Add skill categories and items. ONLY the skills you enter here will be included.</p>
                <div id="skillsContainer">
                    </div>
                <button class="add-btn" onclick="addSkillCategory()">+ Add Skill Category</button>
            </div>
            
            <div class="entry-group">
                <h3>🏆 Certifications</h3>
                <textarea id="certifications" placeholder="Enter certifications (one per line)" onchange="saveManualData()" style="min-height: 100px;"></textarea>
            </div>
            
            <div class="entry-group">
                <h3>💼 Professional Experience</h3>
                <div id="experiencesContainer">
                    </div>
                <button class="add-btn" onclick="addExperience()">+ Add Experience</button>
            </div>
            
            <div class="entry-group">
                <h3>🚀 Projects</h3>
                <div id="projectsContainer">
                    </div>
                <button class="add-btn" onclick="addProject()">+ Add Project</button>
            </div>
            
            <div class="section">
                <h2><span>💼</span> Target Job Description</h2>
                <textarea id="manualJobDescription" placeholder="Paste the complete job description here..." onchange="saveManualData()"></textarea>
                <p class="help-text">Include all requirements, responsibilities, and qualifications</p>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="generateFromManual()">
                    <span>🚀</span> Generate Tailored Resume
                </button>
                <button class="btn btn-save" onclick="saveManualData(true)">
                    <span>💾</span> Save All Data
                </button>
                <button class="btn btn-debug" onclick="validateManualData()">
                    <span>🔍</span> Validate Data
                </button>
                <button class="btn btn-secondary" onclick="clearManualData()">
                    <span>🗑️</span> Clear All Data
                </button>
            </div>
            
            <div class="loading" id="loading-manual">
                <div class="spinner"></div>
                <p class="loading-text">AI is tailoring your resume... This may take 30-60 seconds.</p>
            </div>
        </div>
    </div>
    
    <div id="edit-page" class="page">
        <div class="container">
            <div class="header">
                <h1>✏️ Edit & Finalize Resume</h1>
                <p class="subtitle">Upload your tailored resume PDF and make final adjustments</p>
            </div>
            
            <div id="alert-edit" class="alert"></div>
            
            <div class="section">
                <h2><span>📋</span> Upload Tailored Resume</h2>
                <div class="file-upload" id="pdfUploadDiv">
                    <input type="file" id="pdfFile" accept=".pdf" onchange="handlePdfUpload(event)">
                    <label class="file-upload-label">
                        <span id="pdfLabel">📁 Click to upload your tailored resume PDF</span>
                    </label>
                </div>
                <p class="help-text">Upload the PDF generated from the AI-powered resume page</p>
            </div>
            
            <div class="format-info" id="formatInfo" style="display: none;">
                <h3>⚠️ CRITICAL: Format Requirements for Proper Parsing</h3>
                <ul>
                    <li><strong>Dates MUST have double spaces before them:</strong> <code>University Name  December 2025</code></li>
                    <li><strong>Education format:</strong> University name with double space before graduation date on first line, degree on second line</li>
                    <li><strong>Experience format:</strong> Company name with comma and location on first line, position with double space before date range on second line</li>
                    <li><strong>Project format:</strong> Project title with double space before date range</li>
                    <li><strong>Skills format:</strong> Category name followed by colon and items</li>
                    <li><strong style="color: #d73a49;">IMPORTANT - Bullet points:</strong> Each bullet must be on a SINGLE LINE. Multi-line bullets will be broken. Click "Merge Multi-line Bullets" to fix this automatically!</li>
                </ul>
            </div>
            
            <div id="formatHelpers" style="display: none;">
                <div class="section">
                    <h2><span>🔧</span> Quick Format Helpers</h2>
                    <div class="format-helpers">
                        <button class="format-helper-btn" onclick="autoFormatResume()">🎯 Auto-Format for Parser</button>
                        <button class="format-helper-btn primary" onclick="mergeBulletPoints()">🔗 Merge Multi-line Bullets</button>
                        <button class="format-helper-btn" onclick="fixDateSpacing()">📅 Fix Date Spacing</button>
                        <button class="format-helper-btn" onclick="validateFormat()">✅ Validate Format</button>
                        <button class="format-helper-btn" onclick="showFormatExample()">📋 Show Format Example</button>
                    </div>
                </div>
            </div>
            
            <div id="simpleEditor" style="display: none;">
                <div class="section">
                    <h2><span>✏️</span> Edit Resume Content</h2>
                    
                    <div class="editor-toolbar">
                        <button class="toolbar-btn" onclick="addBullet()">• Add Bullet</button>
                        <button class="toolbar-btn" onclick="addSection()">+ Add Section</button>
                        <button class="toolbar-btn" onclick="formatSelection('upper')">↑ UPPERCASE</button>
                        <button class="toolbar-btn" onclick="formatSelection('title')">Aa Title Case</button>
                        <button class="toolbar-btn" onclick="insertDate()">📅 Insert Date</button>
                        <button class="toolbar-btn" onclick="cleanFormatting()">🧹 Clean Format</button>
                    </div>
                    
                    <textarea id="resumeEditor" 
                              placeholder="Your resume content will appear here exactly as it is in the PDF..."
                              spellcheck="true"></textarea>
                    
                    <p class="help-text" style="margin-top: 10px;">
                        💡 <strong>Important:</strong> Click the red "Merge Multi-line Bullets" button above to fix broken bullet points! This ensures each bullet is on a single line as required by the parser.
                    </p>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="generateFinalResume()" style="display: none;" id="generateFinalBtn">
                    <span>📄</span> Generate Final Resume
                </button>
                <button class="btn btn-secondary" onclick="clearEditForm()">
                    <span>🗑️</span> Clear All
                </button>
            </div>
            
            <div class="loading" id="loading-edit">
                <div class="spinner"></div>
                <p class="loading-text">Generating your final resume...</p>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.4.2/mammoth.browser.min.js"></script>
    
    <script>
        // Set PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';
        
        // Webhook URLs
        const AI_WEBHOOK_URL = 'https://sngsng.app.n8n.cloud/webhook/create-resume';
        const EDIT_WEBHOOK_URL = 'https://sngsng.app.n8n.cloud/webhook/manual-resume';
        
        // Debug mode flag
        let debugMode = false;
        let debugLogs = [];
        
        // Manual entry data structure - SEPARATE from page 1 data
        let manualResumeData = {
            userInfo: {
                name: '',
                location: '',
                phone: '',
                email: '',
                linkedin: ''
            },
            education: {
                current: {
                    university: '',
                    degree: '',
                    graduation: '',
                    coursework: ''
                },
                previous: {
                    university: '',
                    degree: '',
                    graduation: ''
                }
            },
            skills: [],
            certifications: [],
            experiences: [],
            projects: [],
            jobDescription: ''
        };
        
        // Initialize manual entry on page load
        window.addEventListener('DOMContentLoaded', function() {
            loadUserInfo();
            loadManualData();
            updateProgress();
            updateManualDataInspector();
            logDebug('Page loaded, user info and manual data loaded', 'info');
        });
        
        // Debug functions
        function toggleDebug() {
            debugMode = !debugMode;
            const debugPanel = document.getElementById('debugPanel');
            const dataInspector = document.getElementById('dataInspector');
            
            if (debugMode) {
                debugPanel.classList.add('active');
                dataInspector.classList.add('active');
                logDebug('Debug mode activated', 'info');
            } else {
                debugPanel.classList.remove('active');
                dataInspector.classList.remove('active');
            }
        }
        
        function logDebug(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                time: timestamp,
                message: message,
                type: type
            };
            
            debugLogs.push(logEntry);
            
            // Keep only last 50 logs
            if (debugLogs.length > 50) {
                debugLogs.shift();
            }
            
            // Update debug panel
            if (debugMode) {
                const debugLogsDiv = document.getElementById('debugLogs');
                const logDiv = document.createElement('div');
                logDiv.className = `debug-log ${type}`;
                logDiv.textContent = `[${timestamp}] ${message}`;
                debugLogsDiv.appendChild(logDiv);
                
                // Auto-scroll to bottom
                debugLogsDiv.scrollTop = debugLogsDiv.scrollHeight;
            }
            
            // Also log to console
            console.log(`[DEBUG ${timestamp}] ${message}`);
        }
        
        // Update data inspector
        function updateDataInspector() {
            const resumeContent = document.getElementById('resumeContent').value;
            const jobDescription = document.getElementById('jobDescription').value;
            
            // Update lengths
            document.getElementById('resumeLength').textContent = resumeContent.length;
            document.getElementById('jdLength').textContent = jobDescription.length;
            
            // Extract and count projects
            const projects = extractProjectsFromResume(resumeContent);
            document.getElementById('projectCount').textContent = projects.length;
            
            // Display project list
            const projectListDiv = document.getElementById('projectList');
            projectListDiv.innerHTML = '';
            projects.forEach((project, index) => {
                const projectDiv = document.createElement('div');
                projectDiv.className = 'project-item';
                projectDiv.textContent = `${index + 1}. ${project}`;
                projectListDiv.appendChild(projectDiv);
            });
            
            logDebug(`Data updated - Resume: ${resumeContent.length} chars, Projects: ${projects.length}`, 'info');
        }
        
        // Update manual data inspector
        function updateManualDataInspector() {
            document.getElementById('manualExpCount').textContent = manualResumeData.experiences.length;
            document.getElementById('manualProjCount').textContent = manualResumeData.projects.length;
            document.getElementById('manualSkillCount').textContent = manualResumeData.skills.length;
        }
        
        // Extract projects from resume for debugging
        function extractProjectsFromResume(resumeContent) {
            const projects = [];
            
            // Look for PROJECTS section
            const projectsMatch = resumeContent.match(/PROJECTS[\s\S]*$/mi);
            if (projectsMatch) {
                const projectsSection = projectsMatch[0];
                
                // Pattern to find project titles
                const projectPattern = /^([^\n]+?)\s+(?:January|February|March|April|May|June|July|August|September|October|November|December|Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Sept|Oct|Nov|Dec)\s+\d{4}/gm;
                
                let match;
                while ((match = projectPattern.exec(projectsSection)) !== null) {
                    const title = match[1].trim();
                    if (title && !title.includes('PROJECTS') && !title.includes('University')) {
                        projects.push(title);
                    }
                }
            }
            
            return projects;
        }
        
        // ENHANCED MANUAL ENTRY FUNCTIONS
        function saveManualData(showAlert = false) {
            try {
                // ENSURE the structure exists before trying to save
                if (!manualResumeData.userInfo) {
                    manualResumeData.userInfo = {
                        name: '',
                        location: '',
                        phone: '',
                        email: '',
                        linkedin: ''
                    };
                }
                
                if (!manualResumeData.education) {
                    manualResumeData.education = {
                        current: {
                            university: '',
                            degree: '',
                            graduation: '',
                            coursework: ''
                        },
                        previous: {
                            university: '',
                            degree: '',
                            graduation: ''
                        }
                    };
                }
                
                if (!manualResumeData.education.current) {
                    manualResumeData.education.current = {
                        university: '',
                        degree: '',
                        graduation: '',
                        coursework: ''
                    };
                }
                
                if (!manualResumeData.education.previous) {
                    manualResumeData.education.previous = {
                        university: '',
                        degree: '',
                        graduation: ''
                    };
                }
                
                // Now safely save personal info
                manualResumeData.userInfo.name = document.getElementById('manualName')?.value || '';
                manualResumeData.userInfo.location = document.getElementById('manualLocation')?.value || '';
                manualResumeData.userInfo.phone = document.getElementById('manualPhone')?.value || '';
                manualResumeData.userInfo.email = document.getElementById('manualEmail')?.value || '';
                manualResumeData.userInfo.linkedin = document.getElementById('manualLinkedin')?.value || '';
                
                // Save education
                manualResumeData.education.current.university = document.getElementById('currentUniversity')?.value || '';
                manualResumeData.education.current.degree = document.getElementById('currentDegree')?.value || '';
                manualResumeData.education.current.graduation = document.getElementById('currentGraduation')?.value || '';
                manualResumeData.education.current.coursework = document.getElementById('currentCoursework')?.value || '';
                
                manualResumeData.education.previous.university = document.getElementById('previousUniversity')?.value || '';
                manualResumeData.education.previous.degree = document.getElementById('previousDegree')?.value || '';
                manualResumeData.education.previous.graduation = document.getElementById('previousGraduation')?.value || '';
                
                // Save skills - ONLY what's entered
                manualResumeData.skills = [];
                const skillCategories = document.querySelectorAll('#skillsContainer .skill-category');
                skillCategories.forEach(cat => {
                    const categoryName = cat.querySelector('.skill-category-name')?.value || '';
                    const items = cat.querySelector('.skill-items')?.value || '';
                    if (categoryName && items) {
                        manualResumeData.skills.push({ category: categoryName, items: items });
                    }
                });
                
                // Save certifications
                const certsTextarea = document.getElementById('certifications');
                if (certsTextarea) {
                    manualResumeData.certifications = certsTextarea.value
                        .split('\n')
                        .filter(cert => cert.trim());
                }
                
                // Save experiences
                manualResumeData.experiences = [];
                const experienceElements = document.querySelectorAll('#experiencesContainer .dynamic-entry');
                experienceElements.forEach(exp => {
                    const company = exp.querySelector('.exp-company')?.value || '';
                    const location = exp.querySelector('.exp-location')?.value || '';
                    const position = exp.querySelector('.exp-position')?.value || '';
                    const startDate = exp.querySelector('.exp-start-date')?.value || '';
                    const endDate = exp.querySelector('.exp-end-date')?.value || '';
                    const bullets = [];
                    
                    exp.querySelectorAll('.bullet-input').forEach(input => {
                        if (input.value.trim()) {
                            bullets.push(input.value.trim());
                        }
                    });
                    
                    if (company && position) {
                        manualResumeData.experiences.push({
                            company,
                            location,
                            position,
                            dates: `${startDate} - ${endDate}`,
                            bullets
                        });
                    }
                });
                
                // Save projects
                manualResumeData.projects = [];
                const projectElements = document.querySelectorAll('#projectsContainer .dynamic-entry');
                projectElements.forEach(proj => {
                    const title = proj.querySelector('.proj-title')?.value || '';
                    const university = proj.querySelector('.proj-university')?.value || '';
                    const startDate = proj.querySelector('.proj-start-date')?.value || '';
                    const endDate = proj.querySelector('.proj-end-date')?.value || '';
                    const bullets = [];
                    
                    proj.querySelectorAll('.bullet-input').forEach(input => {
                        if (input.value.trim()) {
                            bullets.push(input.value.trim());
                        }
                    });
                    
                    if (title) {
                        manualResumeData.projects.push({
                            title,
                            university: university || 'Northeastern University', // Default if not specified
                            dates: `${startDate} - ${endDate}`,
                            bullets
                        });
                    }
                });
                
                // CRITICAL: Save job description
                const jobDescTextarea = document.getElementById('manualJobDescription');
                if (jobDescTextarea) {
                    manualResumeData.jobDescription = jobDescTextarea.value;
                }
                
                // Save to localStorage with a different key to keep it separate
                localStorage.setItem('manualResumeData', JSON.stringify(manualResumeData));
                
                // Update progress and inspector
                updateProgress();
                updateManualDataInspector();
                
                if (showAlert) {
                    showAlertMessage('All data saved successfully!', 'success', 'manual');
                }
                
                logDebug('Manual data saved successfully', 'info');
                logDebug(`Experiences: ${manualResumeData.experiences.length}, Projects: ${manualResumeData.projects.length}, Skills: ${manualResumeData.skills.length}`, 'info');
                
            } catch (error) {
                console.error('Error saving manual data:', error);
                logDebug('Save error: ' + error.message, 'error');
                showAlertMessage('Error saving data: ' + error.message, 'error', 'manual');
            }
        }
        
        function loadManualData() {
            try {
                const savedData = localStorage.getItem('manualResumeData');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    
                    // VALIDATE AND FIX the structure
                    if (!parsedData.userInfo) {
                        parsedData.userInfo = {
                            name: '',
                            location: '',
                            phone: '',
                            email: '',
                            linkedin: ''
                        };
                    }
                    
                    if (!parsedData.education) {
                        parsedData.education = {
                            current: {
                                university: '',
                                degree: '',
                                graduation: '',
                                coursework: ''
                            },
                            previous: {
                                university: '',
                                degree: '',
                                graduation: ''
                            }
                        };
                    }
                    
                    if (!parsedData.education.current) {
                        parsedData.education.current = {
                            university: '',
                            degree: '',
                            graduation: '',
                            coursework: ''
                        };
                    }
                    
                    if (!parsedData.education.previous) {
                        parsedData.education.previous = {
                            university: '',
                            degree: '',
                            graduation: ''
                        };
                    }
                    
                    if (!parsedData.skills) parsedData.skills = [];
                    if (!parsedData.certifications) parsedData.certifications = [];
                    if (!parsedData.experiences) parsedData.experiences = [];
                    if (!parsedData.projects) parsedData.projects = [];
                    if (!parsedData.jobDescription) parsedData.jobDescription = '';
                    
                    // Now assign the validated data
                    manualResumeData = parsedData;
                    
                    // Load personal info
                    if (document.getElementById('manualName')) {
                        document.getElementById('manualName').value = manualResumeData.userInfo?.name || '';
                        document.getElementById('manualLocation').value = manualResumeData.userInfo?.location || '';
                        document.getElementById('manualPhone').value = manualResumeData.userInfo?.phone || '';
                        document.getElementById('manualEmail').value = manualResumeData.userInfo?.email || '';
                        document.getElementById('manualLinkedin').value = manualResumeData.userInfo?.linkedin || '';
                    }
                    
                    // Load education
                    if (document.getElementById('currentUniversity')) {
                        document.getElementById('currentUniversity').value = manualResumeData.education?.current?.university || '';
                        document.getElementById('currentDegree').value = manualResumeData.education?.current?.degree || '';
                        document.getElementById('currentGraduation').value = manualResumeData.education?.current?.graduation || '';
                        document.getElementById('currentCoursework').value = manualResumeData.education?.current?.coursework || '';
                        
                        document.getElementById('previousUniversity').value = manualResumeData.education?.previous?.university || '';
                        document.getElementById('previousDegree').value = manualResumeData.education?.previous?.degree || '';
                        document.getElementById('previousGraduation').value = manualResumeData.education?.previous?.graduation || '';
                    }
                    
                    // Load skills - clear first to avoid duplicates
                    const skillsContainer = document.getElementById('skillsContainer');
                    if (skillsContainer) {
                        skillsContainer.innerHTML = '';
                        if (manualResumeData.skills && manualResumeData.skills.length > 0) {
                            manualResumeData.skills.forEach(skill => {
                                addSkillCategory(skill);
                            });
                        } else {
                            // Add one empty skill category by default
                            addSkillCategory();
                        }
                    }
                    
                    // Load certifications
                    if (document.getElementById('certifications')) {
                        document.getElementById('certifications').value = (manualResumeData.certifications || []).join('\n');
                    }
                    
                    // Load experiences
                    if (manualResumeData.experiences && manualResumeData.experiences.length > 0) {
                        const container = document.getElementById('experiencesContainer');
                        if (container) {
                            container.innerHTML = '';
                            manualResumeData.experiences.forEach(exp => {
                                addExperience(exp);
                            });
                        }
                    }
                    
                    // Load projects
                    if (manualResumeData.projects && manualResumeData.projects.length > 0) {
                        const container = document.getElementById('projectsContainer');
                        if (container) {
                            container.innerHTML = '';
                            manualResumeData.projects.forEach(proj => {
                                addProject(proj);
                            });
                        }
                    }
                    
                    // CRITICAL: Load job description
                    if (document.getElementById('manualJobDescription') && manualResumeData.jobDescription) {
                        document.getElementById('manualJobDescription').value = manualResumeData.jobDescription;
                    }
                    
                    logDebug('Manual data loaded from localStorage', 'info');
                } else {
                    // Initialize with proper structure
                    manualResumeData = {
                        userInfo: {
                            name: '',
                            location: '',
                            phone: '',
                            email: '',
                            linkedin: ''
                        },
                        education: {
                            current: {
                                university: '',
                                degree: '',
                                graduation: '',
                                coursework: ''
                            },
                            previous: {
                                university: '',
                                degree: '',
                                graduation: ''
                            }
                        },
                        skills: [],
                        certifications: [],
                        experiences: [],
                        projects: [],
                        jobDescription: ''
                    };
                    
                    // Initialize with empty skill category
                    addSkillCategory();
                    logDebug('No saved data found, initializing empty form with proper structure', 'info');
                }
            } catch (error) {
                console.error('Error loading manual data:', error);
                logDebug('Load error: ' + error.message + ' - Reinitializing with clean data', 'error');
                
                // On error, reinitialize with proper structure
                manualResumeData = {
                    userInfo: {
                        name: '',
                        location: '',
                        phone: '',
                        email: '',
                        linkedin: ''
                    },
                    education: {
                        current: {
                            university: '',
                            degree: '',
                            graduation: '',
                            coursework: ''
                        },
                        previous: {
                            university: '',
                            degree: '',
                            graduation: ''
                        }
                    },
                    skills: [],
                    certifications: [],
                    experiences: [],
                    projects: [],
                    jobDescription: ''
                };
                
                // Initialize with empty skill category on error
                addSkillCategory();
            }
        }
        
        // VALIDATE MANUAL DATA BEFORE SUBMISSION
        function validateManualData() {
            const errors = [];
            
            // Check personal info
            if (!manualResumeData.userInfo.name) {
                errors.push('Name is required');
            }
            if (!manualResumeData.userInfo.email) {
                errors.push('Email is required');
            }
            
            // Check education
            if (!manualResumeData.education.current.university || !manualResumeData.education.current.degree) {
                errors.push('Current education details are required');
            }
            
            // Check experiences
            if (manualResumeData.experiences.length === 0) {
                errors.push('At least one professional experience is required');
            } else {
                manualResumeData.experiences.forEach((exp, idx) => {
                    if (!exp.company || !exp.position) {
                        errors.push(`Experience ${idx + 1} is missing company or position`);
                    }
                    if (exp.bullets.length === 0) {
                        errors.push(`Experience ${idx + 1} needs at least one bullet point`);
                    }
                });
            }
            
            // Check projects
            if (manualResumeData.projects.length === 0) {
                errors.push('At least one project is recommended');
            } else {
                manualResumeData.projects.forEach((proj, idx) => {
                    if (!proj.title) {
                        errors.push(`Project ${idx + 1} is missing a title`);
                    }
                    if (proj.bullets.length === 0) {
                        errors.push(`Project ${idx + 1} needs at least one bullet point`);
                    }
                });
            }
            
            // Check skills
            if (manualResumeData.skills.length === 0) {
                errors.push('At least one skill category is required');
            }
            
            // Check job description
            if (!manualResumeData.jobDescription) {
                errors.push('Job description is required');
            }
            
            if (errors.length > 0) {
                showAlertMessage('Validation Errors:\n' + errors.join('\n'), 'error', 'manual');
                logDebug('Validation failed: ' + errors.join(', '), 'error');
                return false;
            } else {
                showAlertMessage('All data is valid and ready for submission!', 'success', 'manual');
                logDebug('Validation passed', 'info');
                return true;
            }
        }
        
        // ENHANCED generateFromManual function
        function generateFromManual() {
            // First, save any pending changes
            saveManualData();
            
            // Validate the data
            if (!validateManualData()) {
                return;
            }
            
            // Convert manual data to resume content format
            const resumeContent = convertManualDataToResumeFormat();
            
            logDebug('=== GENERATING FROM MANUAL ENTRY ===', 'info');
            logDebug(`Resume content generated: ${resumeContent.length} characters`, 'info');
            logDebug(`Experiences: ${manualResumeData.experiences.length}`, 'info');
            logDebug(`Projects: ${manualResumeData.projects.length}`, 'info');
            logDebug(`Skills: ${manualResumeData.skills.length} categories`, 'info');
            
            // Use user info FROM MANUAL ENTRY ONLY
            const userInfo = {
                name: manualResumeData.userInfo.name || 'Your Name',
                location: manualResumeData.userInfo.location || 'City, State',
                phone: manualResumeData.userInfo.phone || '(555) 123-4567',
                email: manualResumeData.userInfo.email || 'email@example.com',
                linkedin: manualResumeData.userInfo.linkedin || 'linkedin.com/in/profile'
            };
            
            logDebug('Using manual entry user info:', 'info');
            logDebug(`Name: ${userInfo.name}`, 'info');
            logDebug(`Email: ${userInfo.email}`, 'info');
            
            // Send to AI webhook
            document.getElementById('loading-manual').style.display = 'block';
            hideAlert('manual');
            
            // CRITICAL: Pass both text format AND structured data
            const requestData = {
                action: 'tailor_resume',
                data: {
                    resumeContent: resumeContent,
                    jobDescription: manualResumeData.jobDescription,
                    isManualEntry: true, // CRITICAL FLAG
                    manualData: manualResumeData, // PASS STRUCTURED DATA
                    ...userInfo
                }
            };
            
            logDebug('Sending request with manual data flag', 'info');
            logDebug(`Request includes ${manualResumeData.experiences.length} experiences and ${manualResumeData.projects.length} projects`, 'info');
            
            fetch(AI_WEBHOOK_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(html => {
                document.getElementById('loading-manual').style.display = 'none';
                
                const resultWindow = window.open('', '_blank');
                if (resultWindow) {
                    resultWindow.document.write(html);
                    resultWindow.document.close();
                    showAlertMessage('Resume tailored successfully! Check the new window.', 'success', 'manual');
                    logDebug('Resume opened in new window', 'info');
                } else {
                    showAlertMessage('Pop-up blocked! Please allow pop-ups for this site.', 'error', 'manual');
                    logDebug('Pop-up blocked', 'error');
                }
            })
            .catch(error => {
                document.getElementById('loading-manual').style.display = 'none';
                showAlertMessage('Error: ' + error.message, 'error', 'manual');
                logDebug(`Request error: ${error.message}`, 'error');
            });
        }
        
        function convertManualDataToResumeFormat() {
            let resume = '';
            
            // Add header (user info is sent separately, so we don't include it here)
            
            // Education Section
            resume += 'EDUCATION\n';
            resume += `${manualResumeData.education.current.university}, ${manualResumeData.education.current.graduation}\n`;
            resume += `${manualResumeData.education.current.degree}\n`;
            if (manualResumeData.education.current.coursework) {
                resume += `Relevant Coursework: ${manualResumeData.education.current.coursework}\n`;
            }
            
            if (manualResumeData.education.previous.university) {
                resume += `${manualResumeData.education.previous.university}, ${manualResumeData.education.previous.graduation}\n`;
                resume += `${manualResumeData.education.previous.degree}\n`;
            }
            
            resume += '\n';
            
            // Technical Skills Section - ONLY FROM MANUAL ENTRY
            resume += 'TECHNICAL SKILLS\n';
            manualResumeData.skills.forEach(skill => {
                resume += `${skill.category}: ${skill.items}\n`;
            });
            
            // Add certifications if any
            if (manualResumeData.certifications.length > 0) {
                resume += `Certifications: ${manualResumeData.certifications.join(', ')}\n`;
            }
            
            resume += '\n';
            
            // Professional Experience Section
            resume += 'PROFESSIONAL EXPERIENCE\n';
            manualResumeData.experiences.forEach(exp => {
                resume += `${exp.company}, ${exp.location}\n`;
                resume += `${exp.position}    ${exp.dates}\n`;
                exp.bullets.forEach(bullet => {
                    resume += `• ${bullet}\n`;
                });
                resume += '\n';
            });
            
            // Projects Section
            resume += 'PROJECTS\n';
            manualResumeData.projects.forEach(proj => {
                resume += `${proj.title}    ${proj.dates}\n`;
                resume += `${proj.university || 'Northeastern University'}\n`;
                proj.bullets.forEach(bullet => {
                    resume += `• ${bullet}\n`;
                });
                resume += '\n';
            });
            
            return resume.trim();
        }
        
        function clearManualData() {
            if (confirm('Are you sure you want to clear all manual data? This cannot be undone.')) {
                localStorage.removeItem('manualResumeData');
                manualResumeData = {
                    userInfo: {
                        name: '',
                        location: '',
                        phone: '',
                        email: '',
                        linkedin: ''
                    },
                    education: {
                        current: {
                            university: '',
                            degree: '',
                            graduation: '',
                            coursework: ''
                        },
                        previous: {
                            university: '',
                            degree: '',
                            graduation: ''
                        }
                    },
                    skills: [],
                    certifications: [],
                    experiences: [],
                    projects: [],
                    jobDescription: ''
                };
                
                // Clear all fields
                document.getElementById('manualName').value = '';
                document.getElementById('manualLocation').value = '';
                document.getElementById('manualPhone').value = '';
                document.getElementById('manualEmail').value = '';
                document.getElementById('manualLinkedin').value = '';
                document.getElementById('currentUniversity').value = '';
                document.getElementById('currentDegree').value = '';
                document.getElementById('currentGraduation').value = '';
                document.getElementById('currentCoursework').value = '';
                document.getElementById('previousUniversity').value = '';
                document.getElementById('previousDegree').value = '';
                document.getElementById('previousGraduation').value = '';
                document.getElementById('certifications').value = '';
                document.getElementById('manualJobDescription').value = '';
                
                // Clear dynamic sections
                document.getElementById('skillsContainer').innerHTML = '';
                addSkillCategory(); // Add one empty category
                document.getElementById('experiencesContainer').innerHTML = '';
                document.getElementById('projectsContainer').innerHTML = '';
                
                updateProgress();
                updateManualDataInspector();
                showAlertMessage('All data cleared!', 'success', 'manual');
                logDebug('Manual data cleared', 'info');
            }
        }
        
        // Dynamic form functions
        function addSkillCategory(data = null) {
            const container = document.getElementById('skillsContainer');
            const div = document.createElement('div');
            div.className = 'skill-category';
            div.innerHTML = `
                <input type="text" placeholder="Category (e.g., Programming Languages)" 
                       class="skill-category-name" value="${data ? data.category : ''}" 
                       onchange="saveManualData()">
                <input type="text" placeholder="Skills (comma-separated, e.g., Python, R, SQL, Java)" 
                       class="skill-items" value="${data ? data.items : ''}" 
                       onchange="saveManualData()">
                <button class="remove-btn" onclick="removeSkillCategory(this)" style="position: relative; margin-top: 5px;">Remove Category</button>
            `;
            container.appendChild(div);
        }
        
        function removeSkillCategory(button) {
            button.parentElement.remove();
            saveManualData();
        }
        
        function addExperience(data = null) {
            const container = document.getElementById('experiencesContainer');
            const div = document.createElement('div');
            div.className = 'dynamic-entry';
            
            const dates = data && data.dates ? data.dates.split(' - ') : ['', ''];
            
            div.innerHTML = `
                <button class="remove-btn" onclick="removeEntry(this)">Remove</button>
                <div class="info-grid">
                    <input type="text" class="exp-company" placeholder="Company Name" 
                           value="${data ? data.company : ''}" onchange="saveManualData()">
                    <input type="text" class="exp-location" placeholder="City, State/Country" 
                           value="${data ? data.location : ''}" onchange="saveManualData()">
                    <input type="text" class="exp-position" placeholder="Position/Title" 
                           value="${data ? data.position : ''}" onchange="saveManualData()">
                </div>
                <div class="date-inputs">
                    <input type="text" class="exp-start-date" placeholder="Start Date (e.g., July 2023)" 
                           value="${dates[0]}" onchange="saveManualData()">
                    <input type="text" class="exp-end-date" placeholder="End Date (e.g., August 2023 or Present)" 
                           value="${dates[1] || ''}" onchange="saveManualData()">
                </div>
                <h4 style="margin-top: 10px;">Bullet Points</h4>
                <div class="bullets-container"></div>
                <button class="add-btn" onclick="addBulletToEntry(this)">+ Add Bullet</button>
            `;
            
            container.appendChild(div);
            
            // Add existing bullets
            if (data && data.bullets) {
                data.bullets.forEach(bullet => {
                    addBulletToEntry(div.querySelector('.add-btn'), bullet);
                });
            } else {
                // Add one empty bullet by default
                addBulletToEntry(div.querySelector('.add-btn'));
            }
        }
        
        function addProject(data = null) {
            const container = document.getElementById('projectsContainer');
            const div = document.createElement('div');
            div.className = 'dynamic-entry';
            
            const dates = data && data.dates ? data.dates.split(' - ') : ['', ''];
            
            div.innerHTML = `
                <button class="remove-btn" onclick="removeEntry(this)">Remove</button>
                <input type="text" class="proj-title" placeholder="Project Title" 
                       value="${data ? data.title : ''}" onchange="saveManualData()" style="margin-bottom: 10px;">
                <input type="text" class="proj-university" placeholder="University/Company Name (e.g., Northeastern University)" 
                       value="${data ? (data.university || '') : ''}" onchange="saveManualData()" style="margin-bottom: 10px;">
                <div class="date-inputs">
                    <input type="text" class="proj-start-date" placeholder="Start Date (e.g., January 2024)" 
                           value="${dates[0]}" onchange="saveManualData()">
                    <input type="text" class="proj-end-date" placeholder="End Date (e.g., March 2024)" 
                           value="${dates[1] || ''}" onchange="saveManualData()">
                </div>
                <h4 style="margin-top: 10px;">Bullet Points</h4>
                <div class="bullets-container"></div>
                <button class="add-btn" onclick="addBulletToEntry(this)">+ Add Bullet</button>
            `;
            
            container.appendChild(div);
            
            // Add existing bullets
            if (data && data.bullets) {
                data.bullets.forEach(bullet => {
                    addBulletToEntry(div.querySelector('.add-btn'), bullet);
                });
            } else {
                // Add one empty bullet by default
                addBulletToEntry(div.querySelector('.add-btn'));
            }
        }
        
        function addBulletToEntry(button, text = '') {
            const container = button.parentElement.querySelector('.bullets-container');
            const div = document.createElement('div');
            div.className = 'bullet-entry';
            div.innerHTML = `
                <input type="text" class="bullet-input" 
                       placeholder="Enter achievement/responsibility (25-40 words)" 
                       value="${text}" onchange="saveManualData()">
                <button class="remove-bullet" onclick="removeBullet(this)">Remove</button>
            `;
            container.appendChild(div);
        }
        
        function removeEntry(button) {
            button.parentElement.remove();
            saveManualData();
            updateManualDataInspector();
        }
        
        function removeBullet(button) {
            button.parentElement.remove();
            saveManualData();
        }
        
        function updateProgress() {
            let filledFields = 0;
            let totalFields = 0;
            
            // Check personal info fields
            const personalFields = ['manualName', 'manualEmail'];
            personalFields.forEach(field => {
                totalFields++;
                if (document.getElementById(field) && document.getElementById(field).value.trim()) filledFields++;
            });
            
            // Check education fields
            const educationFields = ['currentUniversity', 'currentDegree', 'currentGraduation'];
            educationFields.forEach(field => {
                totalFields++;
                if (document.getElementById(field) && document.getElementById(field).value.trim()) filledFields++;
            });
            
            // Check skills
            totalFields++;
            if (manualResumeData.skills.length > 0) filledFields++;
            
            // Check experiences
            totalFields++;
            if (manualResumeData.experiences.length > 0) filledFields++;
            
            // Check projects
            totalFields++;
            if (manualResumeData.projects.length > 0) filledFields++;
            
            // Check job description
            totalFields++;
            if (manualResumeData.jobDescription.trim()) filledFields++;
            
            const progress = Math.round((filledFields / totalFields) * 100);
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = progress + '% Complete';
        }
        
        // Analyze resume content in detail
        function analyzeResumeContent() {
            const resumeContent = document.getElementById('resumeContent').value;
            
            if (!resumeContent) {
                showAlert('Please provide resume content first', 'error', 'ai');
                return;
            }
            
            logDebug('=== ANALYZING RESUME CONTENT ===', 'info');
            
            // Extract all sections
            const sections = {
                education: resumeContent.match(/EDUCATION[\s\S]*?(?=\n[A-Z]+:|$)/mi),
                skills: resumeContent.match(/TECHNICAL SKILLS[\s\S]*?(?=\n[A-Z]+:|$)/mi),
                experience: resumeContent.match(/PROFESSIONAL EXPERIENCE[\s\S]*?(?=\n[A-Z]+:|$)/mi),
                projects: resumeContent.match(/PROJECTS[\s\S]*$/mi)
            };
            
            // Log section findings
            Object.entries(sections).forEach(([section, match]) => {
                if (match) {
                    logDebug(`${section.toUpperCase()} section found: ${match[0].length} characters`, 'info');
                } else {
                    logDebug(`${section.toUpperCase()} section NOT FOUND`, 'warning');
                }
            });
            
            // Detailed project analysis
            if (sections.projects) {
                const projectsText = sections.projects[0];
                const projects = extractProjectsFromResume(resumeContent);
                
                logDebug(`\nPROJECTS ANALYSIS:`, 'info');
                logDebug(`Total projects found: ${projects.length}`, 'info');
                
                projects.forEach((project, index) => {
                    logDebug(`Project ${index + 1}: ${project}`, 'info');
                });
                
                // Check for potential issues
                if (projects.length < 7) {
                    logDebug('WARNING: Found fewer than 7 projects!', 'error');
                    logDebug('This might indicate a parsing issue', 'error');
                }
                
                // Show raw projects section
                logDebug('\nRAW PROJECTS SECTION (first 500 chars):', 'info');
                logDebug(projectsText.substring(0, 500) + '...', 'info');
            }
            
            showAlert('Resume analysis complete! Check the debug console.', 'success', 'ai');
        }
        
        // Page switching
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageId).classList.add('active');
            
            // Update navigation buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (pageId === 'ai-page') {
                document.querySelectorAll('.nav-btn')[0].classList.add('active');
            } else if (pageId === 'manual-page') {
                document.querySelectorAll('.nav-btn')[1].classList.add('active');
            } else {
                document.querySelectorAll('.nav-btn')[2].classList.add('active');
            }
            
            logDebug(`Switched to page: ${pageId}`, 'info');
        }
        
        // Save user information to localStorage
        function saveUserInfo(showAlertFlag = false) {
            const fields = {
                userName: document.getElementById('userName').value,
                userLocation: document.getElementById('userLocation').value,
                userPhone: document.getElementById('userPhone').value,
                userEmail: document.getElementById('userEmail').value,
                userLinkedin: document.getElementById('userLinkedin').value
            };
            
            Object.entries(fields).forEach(([key, value]) => {
                if (value) {
                    localStorage.setItem(key, value);
                }
            });
            
            // Show saved indicator
            const indicator = document.getElementById('savedIndicator');
            indicator.classList.add('show');
            setTimeout(() => indicator.classList.remove('show'), 2000);
            
            if (showAlertFlag) {
                showAlert('Your information has been saved!', 'success', 'ai');
            }
            
            logDebug('User info saved', 'info');
        }
        
        // Load user information from localStorage
        function loadUserInfo() {
            const fields = ['userName', 'userLocation', 'userPhone', 'userEmail', 'userLinkedin'];
            fields.forEach(field => {
                const value = localStorage.getItem(field);
                if (value && document.getElementById(field)) {
                    document.getElementById(field).value = value;
                }
            });
        }
        
        // Handle file upload for AI page
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const fileType = file.name.split('.').pop().toLowerCase();
            const fileUploadDiv = document.getElementById('fileUploadDiv');
            const fileLabel = document.getElementById('fileLabel');
            
            logDebug(`File upload started: ${file.name} (${fileType})`, 'info');
            
            try {
                if (fileType === 'docx') {
                    const arrayBuffer = await file.arrayBuffer();
                    const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                    document.getElementById('resumeContent').value = result.value;
                    fileUploadDiv.classList.add('has-file');
                    fileLabel.textContent = `✅ ${file.name} uploaded successfully`;
                    showAlert('Resume uploaded successfully!', 'success', 'ai');
                    logDebug(`DOCX file processed: ${result.value.length} characters extracted`, 'info');
                } else if (fileType === 'txt') {
                    const text = await file.text();
                    document.getElementById('resumeContent').value = text;
                    fileUploadDiv.classList.add('has-file');
                    fileLabel.textContent = `✅ ${file.name} uploaded successfully`;
                    showAlert('Resume uploaded successfully!', 'success', 'ai');
                    logDebug(`TXT file processed: ${text.length} characters`, 'info');
                } else {
                    showAlert('Please upload a .docx or .txt file', 'error', 'ai');
                    logDebug('Invalid file type', 'error');
                }
                
                updateDataInspector();
            } catch (error) {
                showAlert('Error reading file: ' + error.message, 'error', 'ai');
                logDebug(`File reading error: ${error.message}`, 'error');
            }
        }
        
        // AI-powered resume tailoring with enhanced debugging
        async function tailorResume() {
            const resumeContent = document.getElementById('resumeContent').value;
            const jobDescription = document.getElementById('jobDescription').value;
            
            const userInfo = {
                name: document.getElementById('userName').value || 'Your Name',
                location: document.getElementById('userLocation').value || 'City, State',
                phone: document.getElementById('userPhone').value || '(555) 123-4567',
                email: document.getElementById('userEmail').value || 'email@example.com',
                linkedin: document.getElementById('userLinkedin').value || 'linkedin.com/in/profile'
            };
            
            if (!resumeContent.trim()) {
                showAlert('Please provide your resume content', 'error', 'ai');
                return;
            }
            
            if (!jobDescription.trim()) {
                showAlert('Please provide the job description', 'error', 'ai');
                return;
            }
            
            // Extract projects for debugging
            const projects = extractProjectsFromResume(resumeContent);
            logDebug('=== SENDING TO WORKFLOW ===', 'info');
            logDebug(`Resume length: ${resumeContent.length} characters`, 'info');
            logDebug(`Job description length: ${jobDescription.length} characters`, 'info');
            logDebug(`Projects found in resume: ${projects.length}`, 'info');
            projects.forEach((project, index) => {
                logDebug(`  ${index + 1}. ${project}`, 'info');
            });
            
            document.getElementById('loading-ai').style.display = 'block';
            hideAlert('ai');
            
            const requestData = {
                action: 'tailor_resume',
                data: {
                    resumeContent: resumeContent,
                    jobDescription: jobDescription,
                    isManualEntry: false, // AI page is NOT manual entry
                    ...userInfo
                }
            };
            
            // Log the data being sent
            logDebug('Sending request to webhook...', 'info');
            logDebug(`Request data size: ${JSON.stringify(requestData).length} bytes`, 'info');
            
            try {
                const response = await fetch(AI_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                logDebug(`Response status: ${response.status}`, 'info');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const html = await response.text();
                document.getElementById('loading-ai').style.display = 'none';
                
                logDebug(`Response received: ${html.length} characters`, 'info');
                
                // Check if response contains project information
                const projectsInResponse = (html.match(/project/gi) || []).length;
                logDebug(`Response mentions "project" ${projectsInResponse} times`, 'info');
                
                const resultWindow = window.open('', '_blank');
                if (resultWindow) {
                    resultWindow.document.write(html);
                    resultWindow.document.close();
                    showAlert('Resume tailored successfully! Check the new window.', 'success', 'ai');
                    logDebug('Resume opened in new window', 'info');
                } else {
                    showAlert('Pop-up blocked! Please allow pop-ups for this site.', 'error', 'ai');
                    logDebug('Pop-up blocked', 'error');
                }
                
            } catch (error) {
                document.getElementById('loading-ai').style.display = 'none';
                showAlert('Error: ' + error.message, 'error', 'ai');
                logDebug(`Request error: ${error.message}`, 'error');
            }
        }
        
        // Clear AI form
        function clearForm() {
            document.getElementById('resumeContent').value = '';
            document.getElementById('jobDescription').value = '';
            document.getElementById('resumeFile').value = '';
            document.getElementById('fileUploadDiv').classList.remove('has-file');
            document.getElementById('fileLabel').textContent = '📁 Click to upload resume (.docx or .txt)';
            showAlert('Form cleared!', 'success', 'ai');
            updateDataInspector();
            logDebug('Form cleared', 'info');
        }
        
        // Enhanced PDF Upload Handler with Better Text Extraction
        async function handlePdfUpload(event) {
            const file = event.target.files[0];
            if (!file || file.type !== 'application/pdf') {
                showAlert('Please upload a PDF file', 'error', 'edit');
                return;
            }
            
            const pdfUploadDiv = document.getElementById('pdfUploadDiv');
            const pdfLabel = document.getElementById('pdfLabel');
            
            logDebug(`PDF upload started: ${file.name}`, 'info');
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let fullText = '';
                
                logDebug(`PDF has ${pdf.numPages} pages`, 'info');
                
                // Extract text from all pages
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    const page = await pdf.getPage(pageNum);
                    const textContent = await page.getTextContent();
                    
                    // Process text items
                    let pageText = '';
                    let lastY = null;
                    
                    // Sort items by Y position (top to bottom) then X position (left to right)
                    const sortedItems = textContent.items.sort((a, b) => {
                        const yDiff = b.transform[5] - a.transform[5];
                        if (Math.abs(yDiff) > 2) return yDiff;
                        return a.transform[4] - b.transform[4];
                    });
                    
                    sortedItems.forEach((item, index) => {
                        const currentY = item.transform[5];
                        const currentX = item.transform[4];
                        
                        // Check if this is a new line
                        if (lastY !== null && Math.abs(currentY - lastY) > 2) {
                            pageText += '\n';
                        }
                        
                        // Add the text
                        pageText += item.str;
                        
                        // Check if we need to add space between items on same line
                        if (index < sortedItems.length - 1) {
                            const nextItem = sortedItems[index + 1];
                            const nextY = nextItem.transform[5];
                            const nextX = nextItem.transform[4];
                            
                            // If next item is on same line
                            if (Math.abs(nextY - currentY) <= 2) {
                                const gap = nextX - (currentX + item.width);
                                // Add appropriate spacing
                                if (gap > 30) {
                                    pageText += '  '; // Double space for large gaps
                                } else if (gap > 5) {
                                    pageText += ' '; // Single space for normal gaps
                                }
                            }
                        }
                        
                        lastY = currentY;
                    });
                    
                    fullText += pageText;
                    
                    if (pageNum < pdf.numPages) {
                        fullText += '\n\n';
                    }
                }
                
                // Clean up the extracted text
                fullText = fullText
                    .replace(/\n{3,}/g, '\n\n') // Remove excessive line breaks
                    .trim();
                
                logDebug(`Extracted ${fullText.length} characters from PDF`, 'info');
                
                // Extract projects from PDF for debugging
                const pdfProjects = extractProjectsFromResume(fullText);
                logDebug(`Projects found in PDF: ${pdfProjects.length}`, 'info');
                pdfProjects.forEach((project, index) => {
                    logDebug(`  ${index + 1}. ${project}`, 'info');
                });
                
                // Apply auto-formatting to match parser expectations
                const formattedText = autoFormatExtractedText(fullText);
                
                // Display the formatted text in the editor
                document.getElementById('resumeEditor').value = formattedText;
                
                // Show editor section and format info
                document.getElementById('simpleEditor').style.display = 'block';
                document.getElementById('formatInfo').style.display = 'block';
                document.getElementById('formatHelpers').style.display = 'block';
                document.getElementById('generateFinalBtn').style.display = 'inline-flex';
                
                pdfUploadDiv.classList.add('has-file');
                pdfLabel.textContent = `✅ ${file.name} uploaded successfully`;
                showAlert('PDF uploaded! Click "Merge Multi-line Bullets" button to fix any broken bullet points, then review the formatting below.', 'success', 'edit');
                
                // Auto-focus the editor
                document.getElementById('resumeEditor').focus();
                
            } catch (error) {
                showAlert('Error reading PDF: ' + error.message, 'error', 'edit');
                logDebug(`PDF extraction error: ${error.message}`, 'error');
            }
        }
        
        // Auto-format extracted text to match parser expectations
        function autoFormatExtractedText(text) {
            let lines = text.split('\n');
            let formatted = [];
            let inSection = '';
            let currentBullet = null;
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];
                let trimmedLine = line.trim();
                
                if (!trimmedLine) {
                    // Empty line - end current bullet if exists
                    if (currentBullet) {
                        formatted.push(currentBullet);
                        currentBullet = null;
                    }
                    formatted.push('');
                    continue;
                }
                
                // Detect sections
                if (trimmedLine === 'EDUCATION') inSection = 'education';
                else if (trimmedLine === 'TECHNICAL SKILLS') inSection = 'skills';
                else if (trimmedLine === 'PROFESSIONAL EXPERIENCE') inSection = 'experience';
                else if (trimmedLine === 'PROJECTS') inSection = 'projects';
                
                // Check if this line starts with a bullet
                const isBullet = trimmedLine.startsWith('•') || trimmedLine.startsWith('-') || trimmedLine.startsWith('*');
                
                if (isBullet) {
                    // Save previous bullet if exists
                    if (currentBullet) {
                        formatted.push(currentBullet);
                    }
                    // Start new bullet
                    currentBullet = trimmedLine;
                } else if (currentBullet && (inSection === 'experience' || inSection === 'projects')) {
                    // This is a continuation of the current bullet
                    // Check if this line looks like it should be part of the bullet
                    // (doesn't look like a company name, position, or section header)
                    const looksLikeHeader = /^[A-Z][^,]*,\s*[A-Z]/.test(trimmedLine) || // Company, Location
                                          /\d{4}\s*[-–]\s*\d{4}$/.test(trimmedLine) || // Date range at end
                                          /^(January|February|March|April|May|June|July|August|September|October|November|December|Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Sept|Oct|Nov|Dec)\s+\d{4}/.test(trimmedLine) || // Starts with date
                                          /^[A-Z][A-Z\s]+$/.test(trimmedLine) || // All caps (section header)
                                          trimmedLine === 'Northeastern University'; // Special case
                    
                    if (!looksLikeHeader) {
                        // Append to current bullet with a space
                        currentBullet += ' ' + trimmedLine;
                        continue; // Don't add to formatted yet
                    } else {
                        // This looks like a new section/header, save current bullet
                        formatted.push(currentBullet);
                        currentBullet = null;
                    }
                } else if (currentBullet) {
                    // We're in a different section or found a non-bullet line
                    formatted.push(currentBullet);
                    currentBullet = null;
                }
                
                // If we didn't continue above, process the line normally
                if (!currentBullet) {
                    // Format based on section
                    if (inSection === 'education' && i > 0) {
                        // Check if this line contains a date at the end
                        const dateMatch = trimmedLine.match(/(.*?)\s+(January|February|March|April|May|June|July|August|September|October|November|December|Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Sept|Oct|Nov|Dec)\s+\d{4}$/i);
                        if (dateMatch) {
                            // Add double space before date
                            trimmedLine = dateMatch[1].trim() + '  ' + dateMatch[2] + ' ' + trimmedLine.match(/\d{4}$/)[0];
                        }
                    } else if (inSection === 'experience' && i > 0) {
                        // Check if this is a position line with dates
                        const dateRangeMatch = trimmedLine.match(/(.*?)\s+(January|February|March|April|May|June|July|August|September|October|November|December|Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Sept|Oct|Nov|Dec)\s+\d{4}\s*[-–]\s*(January|February|March|April|May|June|July|August|September|October|November|December|Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Sept|Oct|Nov|Dec)\s+\d{4}$/i);
                        if (dateRangeMatch) {
                            const position = dateRangeMatch[1].trim();
                            const dateRange = trimmedLine.substring(position.length).trim();
                            trimmedLine = position + '  ' + dateRange;
                        }
                    } else if (inSection === 'projects' && i > 0) {
                        // Check if this is a project title with dates
                        const projectDateMatch = trimmedLine.match(/(.*?)\s+(January|February|March|April|May|June|July|August|September|October|November|December|Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Sept|Oct|Nov|Dec)\s+\d{4}\s*[-–]\s*(January|February|March|April|May|June|July|August|September|October|November|December|Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Sept|Oct|Nov|Dec)\s+\d{4}$/i);
                        if (projectDateMatch) {
                            const title = projectDateMatch[1].trim();
                            const dateRange = trimmedLine.substring(title.length).trim();
                            trimmedLine = title + '  ' + dateRange;
                        }
                    }
                    
                    formatted.push(trimmedLine);
                }
            }
            
            // Don't forget the last bullet if exists
            if (currentBullet) {
                formatted.push(currentBullet);
            }
            
            return formatted.join('\n');
        }
        
        // Auto-format resume for parser
        function autoFormatResume() {
            const editor = document.getElementById('resumeEditor');
            const text = editor.value;
            const formatted = autoFormatExtractedText(text);
            editor.value = formatted;
            
            // Also merge multi-line bullets
            mergeBulletPoints();
            
            showAlert('Resume auto-formatted and bullet points merged for parser compatibility!', 'success', 'edit');
            logDebug('Resume auto-formatted', 'info');
        }
        
        // Merge multi-line bullet points into single lines
        function mergeBulletPoints() {
            const editor = document.getElementById('resumeEditor');
            let text = editor.value;
            let lines = text.split('\n');
            let merged = [];
            let currentBullet = null;
            let inBulletSection = false;
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];
                let trimmedLine = line.trim();
                
                // Check if we're in a section that typically has bullets
                if (trimmedLine === 'PROFESSIONAL EXPERIENCE' || trimmedLine === 'PROJECTS') {
                    inBulletSection = true;
                } else if (trimmedLine === 'EDUCATION' || trimmedLine === 'TECHNICAL SKILLS') {
                    inBulletSection = false;
                }
                
                // Check if this line starts with a bullet
                const isBullet = trimmedLine.startsWith('•') || trimmedLine.startsWith('-') || trimmedLine.startsWith('*');
                
                if (isBullet) {
                    // Save previous bullet if exists
                    if (currentBullet) {
                        merged.push(currentBullet);
                    }
                    // Start new bullet
                    currentBullet = line; // Keep original indentation
                } else if (currentBullet && inBulletSection && trimmedLine) {
                    // Check if this looks like a continuation of the bullet
                    const looksLikeNewSection = /^[A-Z][^,]*,\s*[A-Z]/.test(trimmedLine) || // Company, Location
                                               /^\w+\s+(January|February|March|April|May|June|July|August|September|October|November|December|Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Sept|Oct|Nov|Dec)\s+\d{4}/.test(trimmedLine) || // Date pattern
                                               /^[A-Z][A-Z\s]+$/.test(trimmedLine) || // All caps
                                               trimmedLine === 'Northeastern University';
                    
                    if (!looksLikeNewSection) {
                        // Merge with current bullet
                        currentBullet = currentBullet.trimRight() + ' ' + trimmedLine;
                        continue; // Don't add to merged yet
                    } else {
                        // This is a new section, save current bullet
                        merged.push(currentBullet);
                        currentBullet = null;
                    }
                } else if (currentBullet && !trimmedLine) {
                    // Empty line might signal end of bullet
                    merged.push(currentBullet);
                    currentBullet = null;
                } else if (currentBullet) {
                    // Non-bullet, non-empty line - save bullet and continue
                    merged.push(currentBullet);
                    currentBullet = null;
                }
                
                // Add the line if we didn't continue above
                if (!currentBullet || !inBulletSection || !trimmedLine || isBullet) {
                    if (!(currentBullet && isBullet)) { // Don't duplicate the bullet line
                        merged.push(line);
                    }
                }
            }
            
            // Don't forget the last bullet
            if (currentBullet) {
                merged.push(currentBullet);
            }
            
            editor.value = merged.join('\n');
            showAlert('Multi-line bullet points have been merged!', 'success', 'edit');
            logDebug('Bullet points merged', 'info');
        }
        
        // Fix date spacing throughout the document
        function fixDateSpacing() {
            const editor = document.getElementById('resumeEditor');
            let text = editor.value;
            
            // Fix education dates
            text = text.replace(/^(.*?)\s+(January|February|March|April|May|June|July|August|September|October|November|December|Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Sept|Oct|Nov|Dec)\s+(\d{4})$/gm, 
                (match, prefix, month, year) => {
                    return prefix.trim() + '  ' + month + ' ' + year;
                });
            
            // Fix date ranges
            text = text.replace(/^(.*?)\s+(January|February|March|April|May|June|July|August|September|October|November|December|Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Sept|Oct|Nov|Dec)\s+(\d{4})\s*[-–]\s*(.*?)$/gm,
                (match, prefix, startMonth, startYear, rest) => {
                    return prefix.trim() + '  ' + startMonth + ' ' + startYear + ' - ' + rest;
                });
            
            editor.value = text;
            showAlert('Date spacing fixed!', 'success', 'edit');
            logDebug('Date spacing fixed', 'info');
        }
        
        // Validate format
        function validateFormat() {
            const editor = document.getElementById('resumeEditor');
            const text = editor.value;
            const issues = [];
            
            // Check for double spaces before dates
            const datePattern = /\s+(January|February|March|April|May|June|July|August|September|October|November|December|Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Sept|Oct|Nov|Dec)\s+\d{4}/g;
            let match;
            while ((match = datePattern.exec(text)) !== null) {
                const precedingText = text.substring(Math.max(0, match.index - 50), match.index);
                if (!precedingText.endsWith('  ')) {
                    issues.push(`Missing double space before date at: "...${precedingText.slice(-20)}${match[0]}"`);
                }
            }
            
            // Check for section headers
            const requiredSections = ['EDUCATION', 'TECHNICAL SKILLS', 'PROFESSIONAL EXPERIENCE'];
            requiredSections.forEach(section => {
                if (!text.includes(section)) {
                    issues.push(`Missing section: ${section}`);
                }
            });
            
            if (issues.length === 0) {
                showAlert('✅ Format validation passed! Your resume is properly formatted.', 'success', 'edit');
                logDebug('Format validation passed', 'info');
            } else {
                showAlert('⚠️ Format issues found:\n' + issues.join('\n'), 'error', 'edit');
                logDebug(`Format validation failed: ${issues.length} issues found`, 'error');
            }
        }
        
        // Show format example
        function showFormatExample() {
            const example = `FORMAT EXAMPLE (note the double spaces before dates!):\n\nEDUCATION\nNortheastern University  December 2025\nMaster of Science in Engineering Management\nRelevant Coursework: Course 1, Course 2, Course 3\n\nTECHNICAL SKILLS\nProgramming Languages: Python, R, SQL\nTools & Technologies: Tableau, Excel, MS Project\nCertifications: Six Sigma Green Belt\n\nPROFESSIONAL EXPERIENCE\nCompany Name, City, State\nJob Title  Month Year - Month Year\n• Bullet point describing achievement\n• Another bullet point with impact\n\nPROJECTS\nProject Title  Month Year - Month Year\nNortheastern University\n• Project bullet point\n• Another project detail`;
            
            alert(example);
            logDebug('Format example shown', 'info');
        }
        
        // Editor toolbar functions
        function addBullet() {
            const editor = document.getElementById('resumeEditor');
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const text = editor.value;
            
            if (start === end) {
                // No selection, add bullet at cursor
                const before = text.substring(0, start);
                const after = text.substring(start);
                editor.value = before + '\n• ' + after;
                editor.selectionStart = editor.selectionEnd = start + 3;
            } else {
                // Add bullet to selected text
                const selectedText = text.substring(start, end);
                const before = text.substring(0, start);
                const after = text.substring(end);
                editor.value = before + '• ' + selectedText + after;
            }
            editor.focus();
        }
        
        function addSection() {
            const editor = document.getElementById('resumeEditor');
            const position = editor.selectionEnd;
            const text = editor.value;
            const before = text.substring(0, position);
            const after = text.substring(position);
            
            const sectionTemplate = '\n\nSECTION TITLE\n';
            editor.value = before + sectionTemplate + after;
            
            // Select "SECTION TITLE" for easy replacement
            editor.selectionStart = position + 2;
            editor.selectionEnd = position + 15;
            editor.focus();
        }
        
        function formatSelection(type) {
            const editor = document.getElementById('resumeEditor');
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            
            if (start !== end) {
                const text = editor.value;
                const selectedText = text.substring(start, end);
                let formattedText = '';
                
                switch(type) {
                    case 'upper':
                        formattedText = selectedText.toUpperCase();
                        break;
                    case 'title':
                        formattedText = selectedText.replace(/\w\S*/g, (txt) => 
                            txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase()
                        );
                        break;
                }
                
                editor.value = text.substring(0, start) + formattedText + text.substring(end);
                editor.selectionStart = start;
                editor.selectionEnd = start + formattedText.length;
                editor.focus();
            }
        }
        
        function insertDate() {
            const editor = document.getElementById('resumeEditor');
            const position = editor.selectionEnd;
            const text = editor.value;
            const before = text.substring(0, position);
            const after = text.substring(position);
            
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                          'July', 'August', 'September', 'October', 'November', 'December'];
            const now = new Date();
            const dateStr = months[now.getMonth()] + ' ' + now.getFullYear();
            
            editor.value = before + dateStr + after;
            editor.selectionStart = editor.selectionEnd = position + dateStr.length;
            editor.focus();
        }
        
        function cleanFormatting() {
            const editor = document.getElementById('resumeEditor');
            let text = editor.value;
            
            // First, merge multi-line bullets
            let lines = text.split('\n');
            let cleaned = [];
            let currentBullet = null;
            let inBulletSection = false;
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];
                let trimmedLine = line.trim();
                
                // Check sections
                if (trimmedLine === 'PROFESSIONAL EXPERIENCE' || trimmedLine === 'PROJECTS') {
                    inBulletSection = true;
                } else if (trimmedLine === 'EDUCATION' || trimmedLine === 'TECHNICAL SKILLS') {
                    inBulletSection = false;
                }
                
                const isBullet = trimmedLine.startsWith('•') || trimmedLine.startsWith('-') || trimmedLine.startsWith('*');
                
                if (isBullet) {
                    if (currentBullet) cleaned.push(currentBullet);
                    currentBullet = line;
                } else if (currentBullet && inBulletSection && trimmedLine) {
                    const looksLikeNewSection = /^[A-Z][^,]*,\s*[A-Z]/.test(trimmedLine) ||
                                               /^\w+\s+(January|February|March|April|May|June|July|August|September|October|November|December|Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Sept|Oct|Nov|Dec)\s+\d{4}/.test(trimmedLine) ||
                                               /^[A-Z][A-Z\s]+$/.test(trimmedLine) ||
                                               trimmedLine === 'Northeastern University';
                    
                    if (!looksLikeNewSection) {
                        currentBullet = currentBullet.trimRight() + ' ' + trimmedLine;
                        continue;
                    } else {
                        cleaned.push(currentBullet);
                        currentBullet = null;
                    }
                } else if (currentBullet) {
                    cleaned.push(currentBullet);
                    currentBullet = null;
                }
                
                if (!currentBullet || !inBulletSection || !trimmedLine || isBullet) {
                    if (!(currentBullet && isBullet)) {
                        cleaned.push(line);
                    }
                }
            }
            
            if (currentBullet) cleaned.push(currentBullet);
            
            text = cleaned.join('\n');
            
            // Clean common formatting issues
            text = text
                .replace(/\t/g, '    ')           // Convert tabs to spaces
                .replace(/ {3,}/g, '  ')          // Reduce multiple spaces to double
                .replace(/\n{4,}/g, '\n\n\n')     // Limit newlines
                .replace(/[""]/g, '"')            // Normalize quotes
                .replace(/['']/g, "'")            // Normalize apostrophes
                .replace(/[–—]/g, '-')            // Normalize dashes
                .replace(/…/g, '...')             // Normalize ellipsis
                .replace(/Six Seven/g, 'Six')     // Fix common OCR error
                .trim();
            
            editor.value = text;
            showAlert('Formatting cleaned and bullets merged!', 'success', 'edit');
            logDebug('Formatting cleaned', 'info');
        }
        
        // Generate final resume with debugging
        async function generateFinalResume() {
            const editedContent = document.getElementById('resumeEditor').value;
            
            if (!editedContent.trim()) {
                showAlert('Please upload and edit a resume before generating', 'error', 'edit');
                return;
            }
            
            // Extract projects for debugging
            const projects = extractProjectsFromResume(editedContent);
            logDebug('=== SENDING TO MANUAL WORKFLOW ===', 'info');
            logDebug(`Resume length: ${editedContent.length} characters`, 'info');
            logDebug(`Projects found: ${projects.length}`, 'info');
            projects.forEach((project, index) => {
                logDebug(`  ${index + 1}. ${project}`, 'info');
            });
            
            // Get user info from localStorage
            const userInfo = {
                name: localStorage.getItem('userName') || 'Your Name',
                location: localStorage.getItem('userLocation') || 'City, State',
                phone: localStorage.getItem('userPhone') || '(555) 123-4567',
                email: localStorage.getItem('userEmail') || 'email@example.com',
                linkedin: localStorage.getItem('userLinkedin') || 'linkedin.com/in/profile'
            };
            
            document.getElementById('loading-edit').style.display = 'block';
            hideAlert('edit');
            
            const requestData = {
                data: {
                    resumeContent: editedContent,
                    userInfo: userInfo
                }
            };
            
            logDebug('Sending to manual webhook...', 'info');
            
            try {
                const response = await fetch(EDIT_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                logDebug(`Response status: ${response.status}`, 'info');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const html = await response.text();
                document.getElementById('loading-edit').style.display = 'none';
                
                logDebug(`Response received: ${html.length} characters`, 'info');
                
                // Open result in new window
                const resultWindow = window.open('', '_blank');
                if (resultWindow) {
                    resultWindow.document.write(html);
                    resultWindow.document.close();
                    showAlert('Final resume generated successfully! Check the new window.', 'success', 'edit');
                    logDebug('Final resume opened in new window', 'info');
                } else {
                    showAlert('Pop-up blocked! Please allow pop-ups for this site.', 'error', 'edit');
                    logDebug('Pop-up blocked', 'error');
                }
                
            } catch (error) {
                document.getElementById('loading-edit').style.display = 'none';
                showAlert('Error: ' + error.message, 'error', 'edit');
                logDebug(`Request error: ${error.message}`, 'error');
            }
        }
        
        // Clear edit form
        function clearEditForm() {
            document.getElementById('resumeEditor').value = '';
            document.getElementById('pdfFile').value = '';
            document.getElementById('pdfUploadDiv').classList.remove('has-file');
            document.getElementById('pdfLabel').textContent = '📁 Click to upload your tailored resume PDF';
            document.getElementById('simpleEditor').style.display = 'none';
            document.getElementById('formatInfo').style.display = 'none';
            document.getElementById('formatHelpers').style.display = 'none';
            document.getElementById('generateFinalBtn').style.display = 'none';
            showAlert('Form cleared!', 'success', 'edit');
            logDebug('Edit form cleared', 'info');
        }
        
        // Unified alert function
        function showAlertMessage(message, type, page) {
            showAlert(message, type, page);
        }
        
        // Show alert
        function showAlert(message, type, page) {
            let alertId;
            if (page === 'ai') {
                alertId = 'alert-ai';
            } else if (page === 'manual') {
                alertId = 'alert-manual';
            } else {
                alertId = 'alert-edit';
            }
            
            const alert = document.getElementById(alertId);
            alert.textContent = message;
            alert.className = `alert alert-${type}`;
            alert.style.display = 'block';
            
            document.getElementById('lastAction').textContent = `${type.toUpperCase()}: ${message}`;
            
            if (type === 'success') {
                setTimeout(() => hideAlert(page), 5000);
            }
        }
        
        // Hide alert
        function hideAlert(page) {
            let alertId;
            if (page === 'ai') {
                alertId = 'alert-ai';
            } else if (page === 'manual') {
                alertId = 'alert-manual';
            } else {
                alertId = 'alert-edit';
            }
            
            const alert = document.getElementById(alertId);
            alert.style.display = 'none';
        }
    </script>
</body>
</html>
